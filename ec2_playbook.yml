---
- name: Gather system information
  hosts: all
  become: false
  vars:
    dest_file: /tmp/system_info.txt
    local_output_dir: ./system_info_outputs
    local_file_path: "{{ local_output_dir }}/system_info_{{ inventory_hostname }}.txt"
    local_json_file_path: "{{ local_output_dir }}/system_info_{{ inventory_hostname }}.json"

  tasks:
    - name: Ensure local output directory exists
      delegate_to: localhost
      file:
        path: "{{ playbook_dir }}/{{ local_output_dir }}"
        state: directory
      become: false

    - name: Copy command.sh to /tmp/ on remote machine
      copy:
        src: ./command.sh
        dest: /tmp/command.sh
        mode: '0755'
      become: true

    - name: Execute command.sh
      shell: /tmp/command.sh
      register: result
      become: true

    - name: Fetch system_info.txt to local machine
      fetch:
        src: "{{ dest_file }}"
        dest: "{{ local_file_path }}"
        flat: yes

    # print local_file_path and its content
    - name: Print local_file_path
      debug:
        msg: "local_file_path: {{ local_file_path }}"
    - name: Print content of local_file_path
      command: cat "{{ local_file_path }}"
      register: file_content

    - name: Convert TXT to JSON
      delegate_to: localhost
      shell: |
        for file in {{ playbook_dir }}/{{ local_output_dir }}/*.txt; do
          python3 extract_system_info.py "$file" "{{local_json_file_path}}"
        done

    - name: Install required Python module json_dict_diff
      delegate_to: localhost
      shell: |
        pip3 install json_dict_diff

    - name: Ensure the directory structure exists locally
      delegate_to: localhost
      file:
        path: "{{ local_output_dir }}/ec2"
        state: directory

    - name: Download the generated text files to local machine
      fetch:
        src: "{{ local_file_path }}"
        dest: "./{{ local_output_dir }}/ec2/{{ inventory_hostname }}.txt"
        flat: yes
      become: false

    - name: Download the generated JSON files to local machine
      fetch:
        src: "{{ local_json_file_path }}"
        dest: "./{{ local_output_dir }}/ec2/{{ inventory_hostname }}.json"
        flat: yes
      become: false
